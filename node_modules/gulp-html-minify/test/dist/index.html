<!doctype html><html lang="en"><head><meta charset="UTF-8" /><title>Document</title><style type="text/css">#cas{position: absolute;left:0;top:0;bottom: 0;right: 0;margin: auto;border: 1px solid;background:#000;}</style></head><body style="background:#000"><canvas id="cas" width="990" height="540"></canvas><button id="start">开始</button><img src="" alt=""/><button id="stop">暂停</button><script type="text/javascript" charset="utf-8">function loadSound(t,e){ctx.fillStyle="#FFF",ctx.textAlign="center",ctx.textBaseline="middle",ctx.font="20px 微软雅黑",ctx.fillText("音频下载中，请耐心等待...",canvas.width/2,canvas.height/2);var n=new XMLHttpRequest;n.open("get",t),n.responseType="arraybuffer",n.onload=function(){musicBuffer=n.response,e()},n.send()}function decodeBuffer(t){AC.decodeAudioData(t,function(t){playMusic(t),initAnimation()},function(t){console.log(t),alert("文件解码失败")})}function changeBuffer(t){var e=new FileReader;e.onload=function(t){var e=t.target.result;AC.decodeAudioData(e,function(t){playMusic(t)},function(t){console.log(t),alert("文件解码失败")})},e.readAsArrayBuffer(t)}function playMusic(t,e){absn=AC.createBufferSource(),analyser=AC.createAnalyser(),absn.connect(analyser),absn.connect(AC.destination),absn.buffer=t,absn.loop=!0,isstart=!0,myBuffer=t,absn.start(0,e||0),starttime=new Date}function initAnimation(){outcanvas=document.createElement("canvas"),outcanvas.width=canvas.width,outcanvas.height=canvas.height/2;var t=new Uint8Array(analyser.frequencyBinCount);analyser.getByteFrequencyData(t);for(var e=t.length/tgn-jg,n=0;tgn>n;n++)tgs.push(new retangle(e,5,n*(t.length/tgn),canvas.height/2));ot=new Date,animate()}function animate(){var t=new Uint8Array(analyser.frequencyBinCount);analyser.getByteFrequencyData(t),ctx.clearRect(0,0,canvas.width,canvas.height);for(var e=new Date,n=0;n<tgs.length;n++)tgs[n].update(t[~~(n*t.length/tgn)],(e-ot)/1e3);copy(),ot=e,RAF(animate)}function copy(){for(var t=outcanvas.getContext("2d"),e=ctx.getImageData(0,0,canvas.width,canvas.height/2),n=0;n<e.data.length;n+=4)e.data[n+3]=50;t.putImageData(e,0,0),ctx.save(),ctx.translate(canvas.width/2,canvas.height/2),ctx.rotate(Math.PI),ctx.scale(-1,1),ctx.drawImage(outcanvas,-canvas.width/2,-canvas.height/2),ctx.restore()}var canvas=document.getElementById("cas"),ctx=canvas.getContext("2d"),musicBuffer=null;window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext,window.RAF=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)}}();var AC=new AudioContext;loadSound("http://sc.111ttt.com/up/mp3/157360/884D6EB436151C1C5C20D1481EBED8DC.mp3",function(){decodeBuffer(musicBuffer)});var analyser,starttime=0,bftime=0,isstart=!1,absn,myBuffer;document.getElementById("start").onclick=function(){isstart||playMusic(myBuffer,bftime)},document.getElementById("stop").onclick=function(){isstart&&(absn.stop(),bftime+=(new Date-starttime)/1e3,isstart=!1)};var tgs=[],tgn=35,jg=4,ot=0,outcanvas=null,grd=ctx.createLinearGradient(0,110,0,270);grd.addColorStop(0,"red"),grd.addColorStop(.3,"yellow"),grd.addColorStop(1,"#00E800");var retangle=function(t,e,n,a){this.w=t,this.h=e,this.x=n,this.y=a,this.jg=3,this.power=0,this.dy=a,this.dv=100,this.num=0,this.a=50*Math.random()+100,this.b=50*Math.random()+120};retangle.prototype={update:function(t,e){this.power=t,this.num=~~(this.power/this.h+.5),this.power>this.y-(this.dy+this.h)?this.dy=this.y-this.power-this.h-1:this.dy+this.h>this.y?this.dy=this.y-this.h:this.dy+=this.dv*e,this.draw()},draw:function(){ctx.fillStyle=grd;var t=~~(this.power/(this.h+this.jg))*(this.h+this.jg);ctx.fillRect(this.x,this.y-t,this.w,t);for(var e=0;e<this.num;e++){var n=this.y-e*(this.h+this.jg);ctx.clearRect(this.x-1,n,this.w+2,this.jg)}ctx.fillStyle="#950000",ctx.fillRect(this.x,this.dy,this.w,this.h)}};</script></body></html>